<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>super_gradients.training.utils.detection_utils &mdash; SuperGradients 1.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> SuperGradients
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">SuperGradients</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../welcome.html">SuperGradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../super_gradients.common.html">Common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../super_gradients.training.html">Training</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">SuperGradients</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>super_gradients.training.utils.detection_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for super_gradients.training.utils.detection_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">deprecated</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="n">kmeans</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">super_gradients.common.abstractions.abstract_logger</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">ListConfig</span>


<div class="viewcode-block" id="base_detection_collate_fn"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.base_detection_collate_fn">[docs]</a><span class="k">def</span> <span class="nf">base_detection_collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch Processing helper function for detection training/testing.</span>
<span class="sd">    stacks the lists of images and targets into tensors and adds the image index to each target (so the targets could</span>
<span class="sd">    later be associated to the correct images)</span>
<span class="sd">         :param batch:   Input batch from the Dataset __get_item__ method</span>
<span class="sd">         :return:        batch with the transformed values</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="n">images_batch</span><span class="p">,</span> <span class="n">labels_batch</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">):</span>
        <span class="c1"># ADD TARGET IMAGE INDEX</span>
        <span class="n">labels</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images_batch</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_xyxy_bbox_to_xywh"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.convert_xyxy_bbox_to_xywh">[docs]</a><span class="k">def</span> <span class="nf">convert_xyxy_bbox_to_xywh</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert_xyxy_bbox_to_xywh - Converts bounding box format from [x1, y1, x2, y2] to [x, y, w, h]</span>
<span class="sd">        :param input_bbox:  input bbox</span>
<span class="sd">        :return:            Converted bbox</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">converted_bbox</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">)</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">converted_bbox</span></div>


<div class="viewcode-block" id="convert_xywh_bbox_to_xyxy"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.convert_xywh_bbox_to_xyxy">[docs]</a><span class="k">def</span> <span class="nf">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts bounding box format from [x, y, w, h] to [x1, y1, x2, y2]</span>
<span class="sd">        :param input_bbox:  input bbox either 2-dimensional (for all boxes of a single image) or 3-dimensional (for</span>
<span class="sd">                            boxes of a batch of images)</span>
<span class="sd">        :return:            Converted bbox in same dimensions as the original</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">need_squeeze</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># the input is always processed as a batch. in case it not a batch, it is unsqueezed, process and than squeeze back.</span>
    <span class="k">if</span> <span class="n">input_bbox</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">need_squeeze</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">input_bbox</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">converted_bbox</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input_bbox</span><span class="p">)</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">converted_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_bbox</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># squeeze back if needed</span>
    <span class="k">if</span> <span class="n">need_squeeze</span><span class="p">:</span>
        <span class="n">converted_bbox</span> <span class="o">=</span> <span class="n">converted_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">converted_bbox</span></div>


<div class="viewcode-block" id="calculate_wh_iou"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.calculate_wh_iou">[docs]</a><span class="k">def</span> <span class="nf">calculate_wh_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate_wh_iou - Gets the Intersection over Union of the w,h values of the bboxes</span>
<span class="sd">        :param box1:</span>
<span class="sd">        :param box2:</span>
<span class="sd">        :return: IOU</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RETURNS THE IOU OF WH1 TO WH2. WH1 IS 2, WH2 IS NX2</span>
    <span class="n">box2</span> <span class="o">=</span> <span class="n">box2</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

    <span class="c1"># W, H = BOX1</span>
    <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># INTERSECTION AREA</span>
    <span class="n">intersection_area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>

    <span class="c1"># UNION AREA</span>
    <span class="n">union_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span> <span class="o">-</span> <span class="n">intersection_area</span>

    <span class="k">return</span> <span class="n">intersection_area</span> <span class="o">/</span> <span class="n">union_area</span></div>


<span class="k">def</span> <span class="nf">_iou</span><span class="p">(</span><span class="n">CIoU</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">DIoU</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">GIoU</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function for the use of calculate_bbox_iou_matrix and calculate_bbox_iou_elementwise functions</span>
<span class="sd">    DO NOT CALL THIS FUNCTIONS DIRECTLY - use one of the functions mentioned above</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Intersection area</span>
    <span class="n">intersection_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_x2</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_x1</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
                        <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_y1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Union Area</span>
    <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">b1_x2</span> <span class="o">-</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">-</span> <span class="n">b1_y1</span>
    <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">b2_x2</span> <span class="o">-</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">-</span> <span class="n">b2_y1</span>
    <span class="n">union_area</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span> <span class="o">-</span> <span class="n">intersection_area</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection_area</span> <span class="o">/</span> <span class="n">union_area</span>  <span class="c1"># iou</span>
    <span class="k">if</span> <span class="n">GIoU</span> <span class="ow">or</span> <span class="n">DIoU</span> <span class="ow">or</span> <span class="n">CIoU</span><span class="p">:</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_x2</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_x1</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">)</span>  <span class="c1"># convex (smallest enclosing box) width</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_y1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">)</span>  <span class="c1"># convex height</span>
        <span class="c1"># Generalized IoU https://arxiv.org/pdf/1902.09630.pdf</span>
        <span class="k">if</span> <span class="n">GIoU</span><span class="p">:</span>
            <span class="n">c_area</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">*</span> <span class="n">ch</span> <span class="o">+</span> <span class="n">eps</span>  <span class="c1"># convex area</span>
            <span class="n">iou</span> <span class="o">-=</span> <span class="p">(</span><span class="n">c_area</span> <span class="o">-</span> <span class="n">union_area</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_area</span>  <span class="c1"># GIoU</span>
        <span class="c1"># Distance or Complete IoU https://arxiv.org/abs/1911.08287v1</span>
        <span class="k">if</span> <span class="n">DIoU</span> <span class="ow">or</span> <span class="n">CIoU</span><span class="p">:</span>
            <span class="c1"># convex diagonal squared</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ch</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">eps</span>
            <span class="c1"># centerpoint distance squared</span>
            <span class="n">rho2</span> <span class="o">=</span> <span class="p">((</span><span class="n">b2_x1</span> <span class="o">+</span> <span class="n">b2_x2</span> <span class="o">-</span> <span class="n">b1_x1</span> <span class="o">-</span> <span class="n">b1_x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">b2_y1</span> <span class="o">+</span> <span class="n">b2_y2</span> <span class="o">-</span> <span class="n">b1_y1</span> <span class="o">-</span> <span class="n">b1_y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="n">DIoU</span><span class="p">:</span>
                <span class="n">iou</span> <span class="o">-=</span> <span class="n">rho2</span> <span class="o">/</span> <span class="n">c2</span>  <span class="c1"># DIoU</span>
            <span class="k">elif</span> <span class="n">CIoU</span><span class="p">:</span>  <span class="c1"># https://github.com/Zzh-tju/DIoU-SSD-pytorch/blob/master/utils/box/box_utils.py#L47</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">w2</span> <span class="o">/</span> <span class="n">h2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">w1</span> <span class="o">/</span> <span class="n">h1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">-</span> <span class="n">iou</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">iou</span> <span class="o">-=</span> <span class="p">(</span><span class="n">rho2</span> <span class="o">/</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>  <span class="c1"># CIoU</span>
    <span class="k">return</span> <span class="n">iou</span>


<div class="viewcode-block" id="calculate_bbox_iou_matrix"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.calculate_bbox_iou_matrix">[docs]</a><span class="k">def</span> <span class="nf">calculate_bbox_iou_matrix</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">x1y1x2y2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">GIoU</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">DIoU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">CIoU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate iou matrix containing the iou of every couple iuo(i,j) where i is in box1 and j is in box2</span>
<span class="sd">        :param box1: a 2D tensor of boxes (shape N x 4)</span>
<span class="sd">        :param box2: a 2D tensor of boxes (shape M x 4)</span>
<span class="sd">        :param x1y1x2y2: boxes format is x1y1x2y2 (True) or xywh where xy is the center (False)</span>
<span class="sd">        :return: a 2D iou matrix (shape NxM)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">box1</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">box1</span> <span class="o">=</span> <span class="n">box1</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Get the coordinates of bounding boxes</span>
    <span class="k">if</span> <span class="n">x1y1x2y2</span><span class="p">:</span>  <span class="c1"># x1, y1, x2, y2 = box1</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># x, y, w, h = box1</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_x2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_x2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">b1_x1</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b1_y1</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b1_x2</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b1_y2</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_iou</span><span class="p">(</span><span class="n">CIoU</span><span class="p">,</span> <span class="n">DIoU</span><span class="p">,</span> <span class="n">GIoU</span><span class="p">,</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_bbox_iou_elementwise"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.calculate_bbox_iou_elementwise">[docs]</a><span class="k">def</span> <span class="nf">calculate_bbox_iou_elementwise</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">x1y1x2y2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">GIoU</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">DIoU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">CIoU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate elementwise iou of two bbox tensors</span>
<span class="sd">        :param box1: a 2D tensor of boxes (shape N x 4)</span>
<span class="sd">        :param box2: a 2D tensor of boxes (shape N x 4)</span>
<span class="sd">        :param x1y1x2y2: boxes format is x1y1x2y2 (True) or xywh where xy is the center (False)</span>
<span class="sd">        :return: a 1D iou tensor (shape N)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Returns the IoU of box1 to box2. box1 is 4, box2 is nx4</span>
    <span class="n">box2</span> <span class="o">=</span> <span class="n">box2</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Get the coordinates of bounding boxes</span>
    <span class="k">if</span> <span class="n">x1y1x2y2</span><span class="p">:</span>  <span class="c1"># x1, y1, x2, y2 = box1</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># x, y, w, h = box1</span>
        <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_x2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_x2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">_iou</span><span class="p">(</span><span class="n">CIoU</span><span class="p">,</span> <span class="n">DIoU</span><span class="p">,</span> <span class="n">GIoU</span><span class="p">,</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y1</span><span class="p">,</span> <span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_bbox_iou_matrix"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.calc_bbox_iou_matrix">[docs]</a><span class="k">def</span> <span class="nf">calc_bbox_iou_matrix</span><span class="p">(</span><span class="n">pred</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate iou for every pair of boxes in the boxes vector</span>
<span class="sd">    :param pred: a 3-dimensional tensor containing all boxes for a batch of images [N, num_boxes, 4], where</span>
<span class="sd">                 each box format is [x1,y1,x2,y2]</span>
<span class="sd">    :return: a 3-dimensional matrix where M_i_j_k is the iou of box j and box k of the i&#39;th image in the batch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">#</span>
    <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y1</span> <span class="o">=</span> <span class="n">box</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">box</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b1_x2</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">=</span> <span class="n">box</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">box</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">b2_x1</span> <span class="o">=</span> <span class="n">b1_x1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b2_x2</span> <span class="o">=</span> <span class="n">b1_x2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b2_y1</span> <span class="o">=</span> <span class="n">b1_y1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b2_y2</span> <span class="o">=</span> <span class="n">b1_y2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">intersection_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_x2</span><span class="p">,</span> <span class="n">b2_x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_x1</span><span class="p">,</span> <span class="n">b2_x1</span><span class="p">))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
                        <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">b1_y2</span><span class="p">,</span> <span class="n">b2_y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">b1_y1</span><span class="p">,</span> <span class="n">b2_y1</span><span class="p">))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Union Area</span>
    <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">b1_x2</span> <span class="o">-</span> <span class="n">b1_x1</span><span class="p">,</span> <span class="n">b1_y2</span> <span class="o">-</span> <span class="n">b1_y1</span>
    <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">b2_x2</span> <span class="o">-</span> <span class="n">b2_x1</span><span class="p">,</span> <span class="n">b2_y2</span> <span class="o">-</span> <span class="n">b2_y1</span>
    <span class="n">union_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span> <span class="o">-</span> <span class="n">intersection_area</span>
    <span class="n">ious</span> <span class="o">=</span> <span class="n">intersection_area</span> <span class="o">/</span> <span class="n">union_area</span>
    <span class="k">return</span> <span class="n">ious</span></div>


<div class="viewcode-block" id="build_detection_targets"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.build_detection_targets">[docs]</a><span class="k">def</span> <span class="nf">build_detection_targets</span><span class="p">(</span><span class="n">detection_net</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    build_detection_targets - Builds the outputs of the Detection NN</span>
<span class="sd">                              This function filters all of the targets that don&#39;t have a sufficient iou coverage</span>
<span class="sd">                              of the Model&#39;s pre-trained k-means anchors</span>
<span class="sd">                              The iou_threshold is a parameter of the NN Model</span>
<span class="sd">        :param detection_net:   The nn.Module of the Detection Algorithm</span>
<span class="sd">        :param targets:         targets (labels)</span>
<span class="sd">        :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TARGETS = [image, class, x, y, w, h]</span>
    <span class="n">targets_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">target_classes</span><span class="p">,</span> <span class="n">target_bbox</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anchor_vector_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">reject</span><span class="p">,</span> <span class="n">use_all_anchors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">detection_net</span><span class="o">.</span><span class="n">yolo_layers_indices</span><span class="p">:</span>
        <span class="n">yolo_layer_module</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">detection_net</span><span class="o">.</span><span class="n">module_list</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># GET NUMBER OF GRID POINTS AND ANCHOR VEC FOR THIS YOLO LAYER</span>
        <span class="n">grid_points_num</span><span class="p">,</span> <span class="n">anchor_vec</span> <span class="o">=</span> <span class="n">yolo_layer_module</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">yolo_layer_module</span><span class="o">.</span><span class="n">anchor_vec</span>

        <span class="c1"># IOU OF TARGETS-ANCHORS</span>
        <span class="n">iou_targets</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">targets</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">gwh</span> <span class="o">=</span> <span class="n">iou_targets</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_points_num</span>
        <span class="k">if</span> <span class="n">targets_num</span><span class="p">:</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">calculate_wh_iou</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gwh</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">anchor_vec</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">use_all_anchors</span><span class="p">:</span>
                <span class="n">anchors_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor_vec</span><span class="p">)</span>
                <span class="n">anchors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">anchors_num</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">targets_num</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">iou_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">anchors_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">gwh</span> <span class="o">=</span> <span class="n">gwh</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">anchors_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># USE ONLY THE BEST ANCHOR</span>
                <span class="n">iou</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">iou</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># best iou and anchor</span>

            <span class="c1"># REJECT ANCHORS BELOW IOU_THRES (OPTIONAL, INCREASES P, LOWERS R)</span>
            <span class="k">if</span> <span class="n">reject</span><span class="p">:</span>
                <span class="c1"># IOU THRESHOLD HYPERPARAMETER</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">iou</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">detection_net</span><span class="o">.</span><span class="n">iou_t</span>
                <span class="n">iou_targets</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">gwh</span> <span class="o">=</span> <span class="n">iou_targets</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">gwh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># INDICES</span>
        <span class="n">target_image</span><span class="p">,</span> <span class="n">target_class</span> <span class="o">=</span> <span class="n">iou_targets</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="n">x_y_grid</span> <span class="o">=</span> <span class="n">iou_targets</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_points_num</span>
        <span class="n">x_grid_idx</span><span class="p">,</span> <span class="n">y_grid_idx</span> <span class="o">=</span> <span class="n">x_y_grid</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">target_image</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">y_grid_idx</span><span class="p">,</span> <span class="n">x_grid_idx</span><span class="p">))</span>

        <span class="c1"># GIoU</span>
        <span class="n">x_y_grid</span> <span class="o">-=</span> <span class="n">x_y_grid</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span>
        <span class="n">target_bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_y_grid</span><span class="p">,</span> <span class="n">gwh</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">anchor_vector_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchor_vec</span><span class="p">[</span><span class="n">anchors</span><span class="p">])</span>

        <span class="c1"># Class</span>
        <span class="n">target_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_class</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_class</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">detection_net</span><span class="o">.</span><span class="n">num_classes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Labeled Class is out of bounds of the classes list&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target_classes</span><span class="p">,</span> <span class="n">target_bbox</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anchor_vector_list</span></div>


<div class="viewcode-block" id="yolo_v3_non_max_suppression"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.yolo_v3_non_max_suppression">[docs]</a><span class="k">def</span> <span class="nf">yolo_v3_non_max_suppression</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">conf_thres</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nms_thres</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    non_max_suppression - Removes detections with lower object confidence score than &#39;conf_thres&#39;</span>
<span class="sd">                          Non-Maximum Suppression to further filter detections.</span>
<span class="sd">        :param prediction:      the raw prediction as produced by the yolo_v3 network</span>
<span class="sd">        :param conf_thres:      confidence threshold - only prediction with confidence score higher than the threshold</span>
<span class="sd">                                will be considered</span>
<span class="sd">        :param nms_thres:       IoU threshold for the nms algorithm</span>
<span class="sd">        :param device:          the device to move all output tensors into</span>
<span class="sd">        :return:  (x1, y1, x2, y2, object_conf, class_conf, class)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># MINIMUM AND MAXIMIUM BOX WIDTH AND HEIGHT IN PIXELS</span>
    <span class="n">min_wh</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">max_wh</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">image_i</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">):</span>
        <span class="c1"># MULTIPLY CONF BY CLASS CONF TO GET COMBINED CONFIDENCE</span>
        <span class="n">class_conf</span><span class="p">,</span> <span class="n">class_pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">class_conf</span>

        <span class="c1"># IGNORE ANYTHING UNDER conf_thres</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">conf_thres</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_wh</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_wh</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> \
            <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># NOTHING IS OVER THE THRESHOLD</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">class_conf</span> <span class="o">=</span> <span class="n">class_conf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">class_pred</span> <span class="o">=</span> <span class="n">class_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># BOX (CENTER X, CENTER Y, WIDTH, HEIGHT) TO (X1, Y1, X2, Y2)</span>
        <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># DETECTIONS ORDERED AS (x1y1x2y2, obj_conf, class_conf, class_pred)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">class_conf</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">class_pred</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># SORT DETECTIONS BY DECREASING CONFIDENCE SCORES</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[(</span><span class="o">-</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

        <span class="c1"># &#39;OR&#39;, &#39;AND&#39;, &#39;MERGE&#39;, &#39;VISION&#39;, &#39;VISION_BATCHED&#39;</span>
        <span class="c1"># MERGE is highest mAP, VISION is fastest</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;MERGE&#39;</span> <span class="k">if</span> <span class="n">conf_thres</span> <span class="o">&lt;=</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s1">&#39;VISION&#39;</span>

        <span class="c1"># BATCHED NMS</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;VISION_BATCHED&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">batched_nms</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span>
                                                  <span class="n">scores</span><span class="o">=</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span>
                                                  <span class="n">idxs</span><span class="o">=</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span>
                                                  <span class="n">iou_threshold</span><span class="o">=</span><span class="n">nms_thres</span><span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="n">image_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="c1"># Non-maximum suppression</span>
        <span class="n">det_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">detection_class</span> <span class="ow">in</span> <span class="n">pred</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">pred</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">detection_class</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># NO NMS REQUIRED FOR A SINGLE CLASS</span>
                <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;VISION&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">dc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">dc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">nms_thres</span><span class="p">)</span>
                <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OR&#39;</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">dc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">iou</span> <span class="o">=</span> <span class="n">calculate_bbox_iou_elementwise</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">iou</span> <span class="o">&lt;</span> <span class="n">nms_thres</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;AND&#39;</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">iou</span> <span class="o">=</span> <span class="n">calculate_bbox_iou_elementwise</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">iou</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">iou</span> <span class="o">&lt;</span> <span class="n">nms_thres</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;MERGE&#39;</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">calculate_bbox_iou_elementwise</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nms_thres</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">dc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">dc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;SOFT&#39;</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">det_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">iou</span> <span class="o">=</span> <span class="n">calculate_bbox_iou_elementwise</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">dc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">iou</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="n">dc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">conf_thres</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">det_max</span><span class="p">):</span>
            <span class="n">det_max</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">det_max</span><span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="n">image_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">det_max</span><span class="p">[(</span><span class="o">-</span><span class="n">det_max</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="change_bbox_bounds_for_image_size"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.change_bbox_bounds_for_image_size">[docs]</a><span class="k">def</span> <span class="nf">change_bbox_bounds_for_image_size</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">):</span>
    <span class="c1"># CLIP BOUNDING XYXY BOUNDING BOXES TO IMAGE SHAPE (HEIGHT, WIDTH)</span>
    <span class="n">boxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">boxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">boxes</span></div>


<div class="viewcode-block" id="rescale_bboxes_for_image_size"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.rescale_bboxes_for_image_size">[docs]</a><span class="k">def</span> <span class="nf">rescale_bboxes_for_image_size</span><span class="p">(</span><span class="n">current_image_shape</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">original_image_shape</span><span class="p">,</span> <span class="n">ratio_pad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rescale_bboxes_for_image_size - Changes the bboxes to fit the original image</span>
<span class="sd">        :param current_image_shape:</span>
<span class="sd">        :param bbox:</span>
<span class="sd">        :param original_image_shape:</span>
<span class="sd">        :param ratio_pad:</span>
<span class="sd">        :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ratio_pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_image_shape</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">original_image_shape</span><span class="p">)</span>
        <span class="c1"># WH PADDING</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">gain</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> \
              <span class="p">(</span><span class="n">current_image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">gain</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">ratio_pad</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">ratio_pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># X PADDING</span>
    <span class="n">bbox</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Y PADDING</span>
    <span class="n">bbox</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bbox</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">/=</span> <span class="n">gain</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">change_bbox_bounds_for_image_size</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">original_image_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bbox</span></div>


<div class="viewcode-block" id="DetectionPostPredictionCallback"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.DetectionPostPredictionCallback">[docs]</a><span class="k">class</span> <span class="nc">DetectionPostPredictionCallback</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="DetectionPostPredictionCallback.forward"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.DetectionPostPredictionCallback.forward">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param x:       the output of your model</span>
<span class="sd">        :param device:  the device to move all output tensors into</span>
<span class="sd">        :return:        a list with length batch_size, each item in the list is a detections</span>
<span class="sd">                        with shape: nx6 (x1, y1, x2, y2, confidence, class) where x and y are in range [0,1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<div class="viewcode-block" id="YoloV3NonMaxSuppression"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.YoloV3NonMaxSuppression">[docs]</a><span class="k">class</span> <span class="nc">YoloV3NonMaxSuppression</span><span class="p">(</span><span class="n">DetectionPostPredictionCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">nms_thres</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_predictions</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_predictions</span> <span class="o">=</span> <span class="n">max_predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nms_thres</span> <span class="o">=</span> <span class="n">nms_thres</span>

<div class="viewcode-block" id="YoloV3NonMaxSuppression.forward"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.YoloV3NonMaxSuppression.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yolo_v3_non_max_suppression</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">conf_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">nms_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_thres</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="IouThreshold"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.IouThreshold">[docs]</a><span class="k">class</span> <span class="nc">IouThreshold</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">MAP_05</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">MAP_05_TO_095</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

<div class="viewcode-block" id="IouThreshold.is_range"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.IouThreshold.is_range">[docs]</a>    <span class="k">def</span> <span class="nf">is_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="scale_img"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.scale_img">[docs]</a><span class="k">def</span> <span class="nf">scale_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pad_to_original_img_size</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scales the image by ratio (image dims is (batch_size, channels, height, width)</span>
<span class="sd">    Taken from Yolov5 Ultralitics repo&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">rescaled_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">rescaled_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># PAD THE IMAGE TO BE A MULTIPLIER OF grid_size. O.W. PAD IT TO THE ORIGINAL IMAGE SIZE</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pad_to_original_img_size</span><span class="p">:</span>
            <span class="c1"># THE MULTIPLIER WHICH THE DIMENSION MUST BE DIVISIBLE BY</span>
            <span class="n">grid_size</span> <span class="o">=</span> <span class="mi">32</span>
            <span class="c1"># COMPUTE THE NEW SIZE OF THE IMAGE TO RETURN</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">/</span> <span class="n">grid_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)]</span>
        <span class="c1"># PAD THE IMAGE TO FIT w, h (EITHER THE ORIGINAL SIZE OR THE NEW SIZE</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="n">rescaled_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="n">rescaled_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.447</span><span class="p">)</span>  <span class="c1"># value = imagenet mean</span></div>


<div class="viewcode-block" id="fuse_conv_and_bn"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.fuse_conv_and_bn">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;use @torch.nn.utils.fuse_conv_bn_eval(conv, bn) instead&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fuse_conv_and_bn</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fuse convolution and batchnorm layers https://tehnokv.com/posts/fusing-batchnorm-and-conv/</span>
<span class="sd">    Taken from Yolov5 Ultralitics repo&quot;&quot;&quot;</span>

    <span class="c1"># init</span>
    <span class="n">fusedconv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
                          <span class="n">conv</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
                          <span class="n">kernel_size</span><span class="o">=</span><span class="n">conv</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span>
                          <span class="n">stride</span><span class="o">=</span><span class="n">conv</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
                          <span class="n">padding</span><span class="o">=</span><span class="n">conv</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
                          <span class="n">groups</span><span class="o">=</span><span class="n">conv</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
                          <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># prepare filters</span>
    <span class="n">w_conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w_bn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">eps</span> <span class="o">+</span> <span class="n">bn</span><span class="o">.</span><span class="n">running_var</span><span class="p">)))</span>
    <span class="n">fusedconv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w_bn</span><span class="p">,</span> <span class="n">w_conv</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">fusedconv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>

    <span class="c1"># prepare spatial bias</span>
    <span class="n">b_conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="n">conv</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">conv</span><span class="o">.</span><span class="n">bias</span>
    <span class="n">b_bn</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">bias</span> <span class="o">-</span> <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">running_mean</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bn</span><span class="o">.</span><span class="n">running_var</span> <span class="o">+</span> <span class="n">bn</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span>
    <span class="n">fusedconv</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">w_bn</span><span class="p">,</span> <span class="n">b_conv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_bn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fusedconv</span></div>


<div class="viewcode-block" id="check_anchor_order"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.check_anchor_order">[docs]</a><span class="k">def</span> <span class="nf">check_anchor_order</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check anchor order against stride order for YOLOv5 Detect() module m, and correct if necessary</span>
<span class="sd">    Taken from Yolov5 Ultralitics repo&quot;&quot;&quot;</span>
    <span class="n">anchor_area</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">delta_area</span> <span class="o">=</span> <span class="n">anchor_area</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">anchor_area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">delta_stride</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># delta s</span>
    <span class="c1"># IF THE SIGN OF THE SUBTRACTION IS DIFFERENT =&gt; THE STRIDE IS NOT ALIGNED WITH ANCHORS =&gt; m.anchors ARE REVERSED</span>
    <span class="k">if</span> <span class="n">delta_area</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">!=</span> <span class="n">delta_stride</span><span class="o">.</span><span class="n">sign</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reversing anchor order&#39;</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">anchors</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">anchors</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="box_iou"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.box_iou">[docs]</a><span class="k">def</span> <span class="nf">box_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># https://github.com/pytorch/vision/blob/master/torchvision/ops/boxes.py</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return intersection-over-union (Jaccard index) of boxes.</span>
<span class="sd">    Both sets of boxes are expected to be in (x1, y1, x2, y2) format.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        box1 (Tensor[N, 4])</span>
<span class="sd">        box2 (Tensor[M, 4])</span>
<span class="sd">    Returns:</span>
<span class="sd">        iou (Tensor[N, M]): the NxM matrix containing the pairwise</span>
<span class="sd">            IoU values for every element in boxes1 and boxes2</span>
<span class="sd">    Taken from Yolov5 Ultralitics repo</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">box_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>
        <span class="c1"># box = 4xn</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">area1</span> <span class="o">=</span> <span class="n">box_area</span><span class="p">(</span><span class="n">box1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">area2</span> <span class="o">=</span> <span class="n">box_area</span><span class="p">(</span><span class="n">box2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># inter(N,M) = (rb(N,M,2) - lt(N,M,2)).clamp(0).prod(2)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">box2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">area1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">area2</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span>  <span class="c1"># iou = inter / (area1 + area2 - inter)</span></div>


<div class="viewcode-block" id="non_max_suppression"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.non_max_suppression">[docs]</a><span class="k">def</span> <span class="nf">non_max_suppression</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">conf_thres</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">agnostic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
    <span class="sd">&quot;&quot;&quot;Performs Non-Maximum Suppression (NMS) on inference results</span>
<span class="sd">        :param prediction: raw model prediction</span>
<span class="sd">        :param conf_thres: below the confidence threshold - prediction are discarded</span>
<span class="sd">        :param iou_thres: IoU threshold for the nms algorithm</span>
<span class="sd">        :param merge: Merge boxes using weighted mean</span>
<span class="sd">        :param classes: (optional list) filter by class</span>
<span class="sd">        :param agnostic: Determines if is class agnostic. i.e. may display a box with 2 predictions</span>
<span class="sd">        :return:  (x1, y1, x2, y2, object_conf, class_conf, class)</span>
<span class="sd">    Returns:</span>
<span class="sd">         detections with shape: nx6 (x1, y1, x2, y2, conf, cls)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: INVESTIGATE THE COMMENTED OUT PARTS AND DECIDE IF TO ERASE OR UNCOMMENT</span>
    <span class="n">number_of_classes</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">candidates_above_thres</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">conf_thres</span>

    <span class="c1"># Settings</span>
    <span class="c1"># min_box_width_and_height = 2</span>
    <span class="n">max_box_width_and_height</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="n">max_num_of_detections</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">require_redundant_detections</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">multi_label_per_box</span> <span class="o">=</span> <span class="n">number_of_classes</span> <span class="o">&gt;</span> <span class="mi">1</span>  <span class="c1"># (adds 0.5ms/img)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">image_idx</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">):</span>
        <span class="c1"># Apply constraints</span>
        <span class="c1"># pred[((pred[..., 2:4] &lt; min_box_width_and_height) | (pred[..., 2:4] &gt; max_box_width_and_height)).any(1), 4] = 0  # width-height</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">candidates_above_thres</span><span class="p">[</span><span class="n">image_idx</span><span class="p">]]</span>  <span class="c1"># confidence</span>

        <span class="c1"># If none remain process next image</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute confidence = object_conf * class_conf</span>
        <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="c1"># Box (center x, center y, width, height) to (x1, y1, x2, y2)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># Detections matrix nx6 (xyxy, conf, cls)</span>
        <span class="k">if</span> <span class="n">multi_label_per_box</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">conf_thres</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">j</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># best class only</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">box</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">float</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)[</span><span class="n">conf</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">conf_thres</span><span class="p">]</span>

        <span class="c1"># Filter by class</span>
        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Apply finite constraint</span>
        <span class="c1"># if not torch.isfinite(x).all():</span>
        <span class="c1">#     x = x[torch.isfinite(x).all(1)]</span>

        <span class="c1"># If none remain process next image</span>
        <span class="n">number_of_boxes</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">number_of_boxes</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Sort by confidence</span>
        <span class="c1"># x = x[x[:, 4].argsort(descending=True)]</span>

        <span class="c1"># Batched NMS</span>
        <span class="c1"># CREATE AN OFFSET OF THE PREDICTIVE BOX OF DIFFERENT CLASSES IF not agnostic</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">agnostic</span> <span class="k">else</span> <span class="n">max_box_width_and_height</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">idx_to_keep</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">torchvision</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">iou_thres</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx_to_keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_num_of_detections</span><span class="p">:</span>  <span class="c1"># limit number of detections</span>
            <span class="n">idx_to_keep</span> <span class="o">=</span> <span class="n">idx_to_keep</span><span class="p">[:</span><span class="n">max_num_of_detections</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">merge</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">number_of_boxes</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># update boxes as boxes(i,4) = weights(i,n) * boxes(n,4)</span>
                <span class="n">iou</span> <span class="o">=</span> <span class="n">box_iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">idx_to_keep</span><span class="p">],</span> <span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iou_thres</span>  <span class="c1"># iou matrix</span>
                <span class="n">box_weights</span> <span class="o">=</span> <span class="n">iou</span> <span class="o">*</span> <span class="n">scores</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="c1"># MERGED BOXES</span>
                <span class="n">pred</span><span class="p">[</span><span class="n">idx_to_keep</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">box_weights</span><span class="p">,</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">box_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">require_redundant_detections</span><span class="p">:</span>
                    <span class="n">idx_to_keep</span> <span class="o">=</span> <span class="n">idx_to_keep</span><span class="p">[</span><span class="n">iou</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># possible CUDA error https://github.com/ultralytics/yolov3/issues/1139</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">idx_to_keep</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">idx_to_keep</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="n">output</span><span class="p">[</span><span class="n">image_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">idx_to_keep</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="check_img_size_divisibilty"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.check_img_size_divisibilty">[docs]</a><span class="k">def</span> <span class="nf">check_img_size_divisibilty</span><span class="p">(</span><span class="n">img_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param img_size: Int, the size of the image (H or W).</span>
<span class="sd">    :param stride: Int, the number to check if img_size is divisible by.</span>
<span class="sd">    :return: (True, None) if img_size is divisble by stride, (False, Suggestions) if it&#39;s not.</span>
<span class="sd">        Note: Suggestions are the two closest numbers to img_size that *are* divisible by stride.</span>
<span class="sd">        For example if img_size=321, stride=32, it will return (False,(352, 320)).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_size</span> <span class="o">=</span> <span class="n">make_divisible</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">stride</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">new_size</span> <span class="o">!=</span> <span class="n">img_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="n">new_size</span><span class="p">,</span> <span class="n">make_divisible</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">stride</span><span class="p">),</span> <span class="n">ceil</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="make_divisible"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.make_divisible">[docs]</a><span class="k">def</span> <span class="nf">make_divisible</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">ceil</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns x evenly divisible by divisor.</span>
<span class="sd">    If ceil=True it will return the closest larger number to the original x, and ceil=False the closest smaller number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ceil</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">)</span> <span class="o">*</span> <span class="n">divisor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">)</span> <span class="o">*</span> <span class="n">divisor</span></div>


<div class="viewcode-block" id="matrix_non_max_suppression"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.matrix_non_max_suppression">[docs]</a><span class="k">def</span> <span class="nf">matrix_non_max_suppression</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thres</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">kernel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                               <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">max_num_of_detections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs Matrix Non-Maximum Suppression (NMS) on inference results</span>
<span class="sd">        https://arxiv.org/pdf/1912.04488.pdf</span>
<span class="sd">        :param pred: raw model prediction (in test mode) - a Tensor of shape [batch, num_predictions, 85]</span>
<span class="sd">        where each item format is (x, y, w, h, object_conf, class_conf, ... 80 classes score ...)</span>
<span class="sd">        :param conf_thres: below the confidence threshold - prediction are discarded</span>
<span class="sd">        :param kernel: type of kernel to use [&#39;gaussian&#39;, &#39;linear&#39;]</span>
<span class="sd">        :param sigma: sigma for the gussian kernel</span>
<span class="sd">        :param max_num_of_detections: maximum number of boxes to output</span>
<span class="sd">        :return:  list of (x1, y1, x2, y2, object_conf, class_conf, class)</span>

<span class="sd">    Returns:</span>
<span class="sd">         detections list with shape: (x1, y1, x2, y2, conf, cls)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># MULTIPLY CONF BY CLASS CONF TO GET COMBINED CONFIDENCE</span>
    <span class="n">class_conf</span><span class="p">,</span> <span class="n">class_pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">class_conf</span>

    <span class="c1"># BOX (CENTER X, CENTER Y, WIDTH, HEIGHT) TO (X1, Y1, X2, Y2)</span>
    <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>

    <span class="c1"># DETECTIONS ORDERED AS (x1y1x2y2, obj_conf, class_conf, class_pred)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">class_pred</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># SORT DETECTIONS BY DECREASING CONFIDENCE SCORES</span>
    <span class="n">sort_ind</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">sort_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">max_num_of_detections</span><span class="p">]</span>

    <span class="n">ious</span> <span class="o">=</span> <span class="n">calc_bbox_iou_matrix</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

    <span class="n">ious</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># CREATE A LABELS MASK, WE WANT ONLY BOXES WITH THE SAME LABEL TO AFFECT EACH OTHER</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">:]</span>
    <span class="n">labeles_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">labels</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ious</span> <span class="o">*=</span> <span class="n">labeles_matrix</span>
    <span class="n">ious_cmax</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ious_cmax</span> <span class="o">=</span> <span class="n">ious_cmax</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_num_of_detections</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">decay_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="n">ious</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">compensate_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="n">ious_cmax</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">decay</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">decay_matrix</span> <span class="o">/</span> <span class="n">compensate_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decay</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ious</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ious_cmax</span><span class="p">)</span>
        <span class="n">decay</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">decay</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">decay</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">conf_thres</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="NMS_Type"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.NMS_Type">[docs]</a><span class="k">class</span> <span class="nc">NMS_Type</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type of non max suppression algorithm that can be used for post processing detection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ITERATIVE</span> <span class="o">=</span> <span class="s1">&#39;iterative&#39;</span>
    <span class="n">MATRIX</span> <span class="o">=</span> <span class="s1">&#39;matrix&#39;</span></div>


<div class="viewcode-block" id="calc_batch_prediction_accuracy"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.calc_batch_prediction_accuracy">[docs]</a><span class="k">def</span> <span class="nf">calc_batch_prediction_accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>  <span class="c1"># noqa: C901</span>
                                   <span class="n">iou_thres</span><span class="p">:</span> <span class="n">IouThreshold</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param output:       list (of length batch_size) of Tensors of shape (num_detections, 6)</span>
<span class="sd">                         format:     (x1, y1, x2, y2, confidence, class_label) where x1,y1,x2,y2 are according to image size</span>
<span class="sd">    :param targets:      targets for all images of shape (total_num_targets, 6)</span>
<span class="sd">                         format:     (image_index, x, y, w, h, label) where x,y,w,h are in range [0,1]</span>
<span class="sd">    :param height,width: dimensions of the image</span>
<span class="sd">    :param iou_thres:    Threshold to compute the mAP</span>
<span class="sd">    :param device:       &#39;cuda&#39;\&#39;cpu&#39; - where the computations are made</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch_images_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">device</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">iou_thres</span><span class="o">.</span><span class="n">is_range</span><span class="p">():</span>
        <span class="n">num_ious</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">iou_thres</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_ious</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">iou_thres</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">iou_thres</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.05</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">iou_thres</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iou_thres</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_ious</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">labels_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">labels_num</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">batch_images_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labels_num</span><span class="p">:</span>
                <span class="n">batch_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_ious</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">target_class</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># CHANGE bboxes TO FIT THE IMAGE SIZE</span>
        <span class="n">change_bbox_bounds_for_image_size</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>

        <span class="c1"># ZEROING ALL OF THE bbox PREDICTIONS BEFORE MAX IOU FILTERATION</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span> <span class="n">num_ious</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels_num</span><span class="p">:</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tcls_tensor</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">target_bboxes</span> <span class="o">=</span> <span class="n">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">target_bboxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">width</span>
            <span class="n">target_bboxes</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">height</span>

            <span class="c1"># SEARCH FOR CORRECT PREDICTIONS</span>
            <span class="c1"># Per target class</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tcls_tensor</span><span class="p">):</span>
                <span class="n">target_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="o">==</span> <span class="n">tcls_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pred_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="o">==</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Search for detections</span>
                <span class="k">if</span> <span class="n">pred_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># Prediction to target ious</span>
                    <span class="n">iou</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">box_iou</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">pred_index</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">target_bboxes</span><span class="p">[</span><span class="n">target_index</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># best ious, indices</span>

                    <span class="c1"># Append detections</span>
                    <span class="n">detected_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">iou</span> <span class="o">&gt;</span> <span class="n">ious</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">detected_target</span> <span class="o">=</span> <span class="n">target_index</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">detected_target</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">detected_set</span><span class="p">:</span>
                            <span class="n">detected_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">detected_target</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                            <span class="n">detected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detected_target</span><span class="p">)</span>
                            <span class="n">correct</span><span class="p">[</span><span class="n">pred_index</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iou</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ious</span>  <span class="c1"># iou_thres is 1xn</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detected</span><span class="p">)</span> <span class="o">==</span> <span class="n">labels_num</span><span class="p">:</span>  <span class="c1"># all targets already located in image</span>
                                <span class="k">break</span>

        <span class="c1"># APPEND STATISTICS (CORRECT, CONF, PCLS, TCLS)</span>
        <span class="n">batch_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">correct</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pred</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">target_class</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">batch_metrics</span><span class="p">,</span> <span class="n">batch_images_counter</span></div>


<div class="viewcode-block" id="AnchorGenerator"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.AnchorGenerator">[docs]</a><span class="k">class</span> <span class="nc">AnchorGenerator</span><span class="p">:</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_metric</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; measure how &#39;far&#39; each object is from the closest anchor</span>
<span class="sd">            :returns a matrix n by number of objects and the measurements to the closest anchor for each object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">r</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_anchor_fitness</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; how well the anchors fit the objects&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_metric</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">best</span> <span class="o">*</span> <span class="p">(</span><span class="n">best</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># fitness</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_print_results</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">num_anchors</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
        <span class="c1"># SORT SMALL TO LARGE (BY AREA)</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_metric</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>
        <span class="n">best_possible_recall</span> <span class="o">=</span> <span class="p">(</span><span class="n">best</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">anchors_above_thesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_anchors</span>

        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;thr=</span><span class="si">{</span><span class="n">thresh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">best_possible_recall</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> best possible recall, </span><span class="si">{</span><span class="n">anchors_above_thesh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> anchors past thr&#39;</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;num_anchors=</span><span class="si">{</span><span class="n">num_anchors</span><span class="si">}</span><span class="s1">, img_size=</span><span class="si">{</span><span class="n">img_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39; metric_all=</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">best</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">-mean/best, past_thr=</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">-mean: &#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mean</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39;,  &#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># use in *.cfg</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_plot_object_distribution</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">objects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">objects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">50</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">objects</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">objects</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">anchors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_anchors</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_anchors</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates kmeans-evolved anchors from training dataset</span>
<span class="sd">            Based on the implementation by Ultralytics for Yolo V5</span>

<span class="sd">            :param dataset: a loaded dataset (must be with cached labels and &quot;train_sample_loading_method&quot;:&#39;rectangular&#39;)</span>
<span class="sd">            :param num_anchors: number of anchors</span>
<span class="sd">            :param thresh: anchor-label wh ratio threshold used to asses if a label can be detected by an anchor.</span>
<span class="sd">                    it means that the aspect ratio of the object is not more than thres from the aspect ratio of the anchor.</span>
<span class="sd">            :param gen: generations to evolve anchors using genetic algorithm. after kmeans, this algorithm iteratively</span>
<span class="sd">                    make minor random changes in the anchors and if a change imporve the anchors-data fit it evolves the</span>
<span class="sd">                    anchors.</span>
<span class="sd">            :returns anchors array num_anchors by 2 (x,y) normalized to image size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_prefix</span> <span class="o">=</span> <span class="s1">&#39;Anchors Generator: &#39;</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_size</span>
        <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cache_labels</span><span class="p">,</span> <span class="s2">&quot;dataset labels have to be cached before generating anchors&quot;</span>

        <span class="n">image_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">exif_size</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">img_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Reading image shapes&#39;</span><span class="p">)])</span>

        <span class="c1"># Get label wh</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">img_size</span> <span class="o">*</span> <span class="n">image_shapes</span> <span class="o">/</span> <span class="n">image_shapes</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">objects_wh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">l</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">)])</span>

        <span class="c1"># Filter</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">objects_wh</span> <span class="o">&lt;</span> <span class="mf">3.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Extremely small objects found. </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects_wh</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels are &lt; 3 pixels in size.&#39;</span><span class="p">)</span>
        <span class="n">object_wh_filtered</span> <span class="o">=</span> <span class="n">objects_wh</span><span class="p">[(</span><span class="n">objects_wh</span> <span class="o">&gt;=</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Kmeans calculation</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running kmeans for </span><span class="si">{</span><span class="n">num_anchors</span><span class="si">}</span><span class="s1"> anchors on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">object_wh_filtered</span><span class="p">)</span><span class="si">}</span><span class="s1"> points...&#39;</span><span class="p">)</span>
        <span class="n">mean_wh</span> <span class="o">=</span> <span class="n">object_wh_filtered</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sigmas for whitening</span>
        <span class="n">anchors</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">object_wh_filtered</span> <span class="o">/</span> <span class="n">mean_wh</span><span class="p">,</span> <span class="n">num_anchors</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># points, mean distance</span>
        <span class="c1"># MEANS WHERE NORMALIZED. SCALE THEM BACK TO IMAGE SIZE</span>
        <span class="n">anchors</span> <span class="o">*=</span> <span class="n">mean_wh</span>

        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initial results&#39;</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_print_results</span><span class="p">(</span><span class="n">objects_wh</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">num_anchors</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_plot_object_distribution</span><span class="p">(</span><span class="n">objects_wh</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

        <span class="c1"># EVOLVE</span>
        <span class="n">fitness</span><span class="p">,</span> <span class="n">generations</span><span class="p">,</span> <span class="n">mutation_prob</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_anchor_fitness</span><span class="p">(</span><span class="n">object_wh_filtered</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span>
                                                                                     <span class="n">thresh</span><span class="p">),</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span>
        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">gen</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s1">Evolving anchors with Genetic Algorithm:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># mutate until a change occurs (prevent duplicates)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mutation_prob</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">generations</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="n">evolved_anchors</span> <span class="o">=</span> <span class="p">(</span><span class="n">anchors</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">evolved_anchors_fitness</span> <span class="o">=</span> <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_anchor_fitness</span><span class="p">(</span><span class="n">object_wh_filtered</span><span class="p">,</span> <span class="n">evolved_anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evolved_anchors_fitness</span> <span class="o">&gt;</span> <span class="n">fitness</span><span class="p">:</span>
                <span class="n">fitness</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">evolved_anchors_fitness</span><span class="p">,</span> <span class="n">evolved_anchors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s1">Evolving anchors with Genetic Algorithm: fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final results&#39;</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_print_results</span><span class="p">(</span><span class="n">objects_wh</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">num_anchors</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
        <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_plot_object_distribution</span><span class="p">(</span><span class="n">objects_wh</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

        <span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
        <span class="n">anchors_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">anchors_list</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_anchors</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AnchorGenerator</span><span class="o">.</span><span class="n">_generate_anchors</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_anchors</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_coco_datasaet_images_with_detections"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.plot_coco_datasaet_images_with_detections">[docs]</a><span class="k">def</span> <span class="nf">plot_coco_datasaet_images_with_detections</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">num_images_to_plot</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_coco_images</span>
<span class="sd">        :param data_loader:</span>
<span class="sd">        :param num_images_to_plot:</span>
<span class="sd">        :return:</span>
<span class="sd">    # &quot;&quot;&quot;</span>
    <span class="n">images_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># PLOT ONE image AND ONE GROUND_TRUTH bbox</span>
    <span class="k">for</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>

        <span class="c1"># PLOTS TRAINING IMAGES OVERLAID WITH TARGETS</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># LIMIT PLOT TO 16 IMAGES</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># NUMBER OF SUBPLOTS</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="n">convert_xywh_bbox_to_xyxy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">boxes</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">w</span>
            <span class="n">boxes</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">h</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">boxes</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">boxes</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;.-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">images_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">images_counter</span> <span class="o">==</span> <span class="n">num_images_to_plot</span><span class="p">:</span>
            <span class="k">break</span></div>


<div class="viewcode-block" id="undo_image_preprocessing"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.undo_image_preprocessing">[docs]</a><span class="k">def</span> <span class="nf">undo_image_preprocessing</span><span class="p">(</span><span class="n">im_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param im_tensor: images in a batch after preprocessing for inference, RGB, (B, C, H, W)</span>
<span class="sd">    :return:          images in a batch in cv2 format, BGR, (B, H, W, C)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im_np</span> <span class="o">=</span> <span class="n">im_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">im_np</span> <span class="o">=</span> <span class="n">im_np</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im_np</span> <span class="o">*=</span> <span class="mf">255.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">im_np</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>


<div class="viewcode-block" id="DetectionVisualization"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.DetectionVisualization">[docs]</a><span class="k">class</span> <span class="nc">DetectionVisualization</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_color_mapping</span><span class="p">(</span><span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a unique BGR color for each class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gist_rainbow&#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_draw_box_title</span><span class="p">(</span><span class="n">color_mapping</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">class_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">box_thickness</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">image_np</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">class_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">pred_conf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color_mapping</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>

        <span class="c1"># Draw the box</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">box_thickness</span><span class="p">)</span>

        <span class="c1"># Caption with class name and confidence if given</span>
        <span class="n">text_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># white</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pred_conf</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">pred_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">box_thickness</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="n">text_color</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lineType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image_np</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_visualize_image</span><span class="p">(</span><span class="n">image_np</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pred_boxes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_boxes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">class_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">box_thickness</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gt_alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">image_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">fx</span><span class="o">=</span><span class="n">image_scale</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="n">image_scale</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">)</span>
        <span class="n">color_mapping</span> <span class="o">=</span> <span class="n">DetectionVisualization</span><span class="o">.</span><span class="n">_generate_color_mapping</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">))</span>

        <span class="c1"># Draw predictions</span>
        <span class="n">pred_boxes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">image_scale</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">pred_boxes</span><span class="p">:</span>
            <span class="n">image_np</span> <span class="o">=</span> <span class="n">DetectionVisualization</span><span class="o">.</span><span class="n">_draw_box_title</span><span class="p">(</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">box_thickness</span><span class="p">,</span>
                                                              <span class="n">image_np</span><span class="p">,</span> <span class="o">*</span><span class="n">box</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                                              <span class="n">class_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">pred_conf</span><span class="o">=</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># Draw ground truths</span>
        <span class="n">target_boxes_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">target_boxes</span><span class="p">:</span>
            <span class="n">target_boxes_image</span> <span class="o">=</span> <span class="n">DetectionVisualization</span><span class="o">.</span><span class="n">_draw_box_title</span><span class="p">(</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">box_thickness</span><span class="p">,</span>
                                                                        <span class="n">target_boxes_image</span><span class="p">,</span> <span class="o">*</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
                                                                        <span class="n">class_id</span><span class="o">=</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Transparent overlay of ground truth boxes</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">target_boxes_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">image_np</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gt_alpha</span><span class="p">,</span> <span class="n">target_boxes_image</span><span class="p">,</span> <span class="n">gt_alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">checkpoint_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image_np</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">),</span> <span class="n">image_np</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_scaled_ccwh_to_xyxy</span><span class="p">(</span><span class="n">target_boxes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">image_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies target_boxes inplace</span>
<span class="sd">        :param target_boxes:    (c1, c2, w, h) boxes in [0, 1] range</span>
<span class="sd">        :param h:               image height</span>
<span class="sd">        :param w:               image width</span>
<span class="sd">        :param image_scale:     desired scale for the boxes w.r.t. w and h</span>
<span class="sd">        :return:                targets in (x1, y1, x2, y2) format</span>
<span class="sd">                                in range [0, w * self.image_scale] [0, h * self.image_scale]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unscale</span>
        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">]])</span>

        <span class="c1"># x1 = c1 - w // 2; y1 = c2 - h // 2</span>
        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># x2 = w + x1; y2 = h + y1</span>
        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">target_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">image_scale</span>
        <span class="n">target_boxes</span> <span class="o">=</span> <span class="n">target_boxes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target_boxes</span>

<div class="viewcode-block" id="DetectionVisualization.visualize_batch"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.DetectionVisualization.visualize_batch">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">visualize_batch</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">pred_boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">target_boxes</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                        <span class="n">batch_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">class_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">undo_preprocessing_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="n">undo_image_preprocessing</span><span class="p">,</span>
                        <span class="n">box_thickness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">gt_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to visualize detections predicted by a network:</span>
<span class="sd">        saves images into a given path with a name that is {batch_name}_{imade_idx_in_the_batch}.jpg, one batch per call.</span>
<span class="sd">        Colors are generated on the fly: uniformly sampled from color wheel to support all given classes.</span>

<span class="sd">        Adjustable:</span>
<span class="sd">            * Ground truth box transparency;</span>
<span class="sd">            * Box width;</span>
<span class="sd">            * Image size (larger or smaller than what&#39;s provided)</span>

<span class="sd">        :param image_tensor:            rgb images, (B, H, W, 3)</span>
<span class="sd">        :param pred_boxes:              boxes after NMS for each image in a batch, each (Num_boxes, 6),</span>
<span class="sd">                                        values on dim 1 are: x1, y1, x2, y2, confidence, class</span>
<span class="sd">        :param target_boxes:            (Num_targets, 6), values on dim 1 are: image id in a batch, class, x y w h</span>
<span class="sd">                                        (coordinates scaled to [0, 1])</span>
<span class="sd">        :param batch_name:              id of the current batch to use for image naming</span>

<span class="sd">        :param class_names:             names of all classes, each on its own index</span>
<span class="sd">        :param checkpoint_dir:          a path where images with boxes will be saved. if None, the result images will</span>
<span class="sd">                                        be returns as a list of numpy image arrays</span>

<span class="sd">        :param undo_preprocessing_func: a function to convert preprocessed images tensor into a batch of cv2-like images</span>
<span class="sd">        :param box_thickness:           box line thickness in px</span>
<span class="sd">        :param image_scale:             scale of an image w.r.t. given image size,</span>
<span class="sd">                                        e.g. incoming images are (320x320), use scale = 2. to preview in (640x640)</span>
<span class="sd">        :param gt_alpha:                a value in [0., 1.] transparency on ground truth boxes,</span>
<span class="sd">                                        0 for invisible, 1 for fully opaque</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">undo_preprocessing_func</span><span class="p">(</span><span class="n">image_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">DetectionVisualization</span><span class="o">.</span><span class="n">_scaled_ccwh_to_xyxy</span><span class="p">(</span><span class="n">target_boxes</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="o">*</span><span class="n">image_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                                                              <span class="n">image_scale</span><span class="p">)</span>

        <span class="n">out_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">if</span> <span class="n">pred_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">targets_cur</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">image_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">batch_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
            <span class="n">res_image</span> <span class="o">=</span> <span class="n">DetectionVisualization</span><span class="o">.</span><span class="n">_visualize_image</span><span class="p">(</span><span class="n">image_np</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">preds</span><span class="p">,</span> <span class="n">targets_cur</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">box_thickness</span><span class="p">,</span> <span class="n">gt_alpha</span><span class="p">,</span> <span class="n">image_scale</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_image</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out_images</span></div></div>


<div class="viewcode-block" id="Anchors"><a class="viewcode-back" href="../../../../super_gradients.training.utils.html#super_gradients.training.utils.detection_utils.Anchors">[docs]</a><span class="k">class</span> <span class="nc">Anchors</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function to hold the anchors used by detection models such as Yolo</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchors_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">],</span> <span class="n">strides</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param anchors_list: of the shape [[w1,h1,w2,h2,w3,h3], [w4,h4,w5,h5,w6,h6] .... where each sublist holds</span>
<span class="sd">            the width and height of the anchors of a specific detection layer.</span>
<span class="sd">            i.e. for a model with 3 detection layers, each containing 5 anchors the format will be a of 3 sublists of 10 numbers each</span>
<span class="sd">            The width and height are in pixels (not relative to image size)</span>
<span class="sd">        :param strides: a list containing the stride of the layers from which the detection heads are fed.</span>
<span class="sd">            i.e. if the firs detection head is connected to the backbone after the input dimensions were reduces by 8, the first number will be 8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_lists</span><span class="p">(</span><span class="n">anchors_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_len_equal_and_even</span><span class="p">(</span><span class="n">anchors_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">strides</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">anchors_list</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors_list</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">anchors</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchor_grid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_all_lists</span><span class="p">(</span><span class="n">anchors</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ListConfig</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;All objects of anchors_list must be lists&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_all_len_equal_and_even</span><span class="p">(</span><span class="n">anchors</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">len_of_first</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_of_first</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;All objects of anchors_list must be of the same even length&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stride</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anchor_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchor_grid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detection_layers_num</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SuperGradients team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>